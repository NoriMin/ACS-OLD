{"version":3,"sources":["utils/positioner/Popper.tsx"],"names":["useIsomorphicLayoutEffect","Ref","isRefObject","PopperJs","React","isBrowser","getBoundary","getScrollParent","getPlacement","applyRtlToOffset","useDeepMemo","memoFn","key","ref","useRef","current","value","useFirstMount","isFirst","useUpdateIsomorphicLayoutEffect","effect","deps","isFirstMount","Popper","props","align","children","enabled","flipBoundary","userModifiers","modifiers","offset","overflowBoundary","pointerTargetRef","popperRef","position","positionFixed","positioningDependencies","rtl","targetRef","unstable_pinned","proposedPlacement","popperInstanceRef","contentRef","latestPlacement","useState","computedPlacement","setComputedPlacement","computedModifiers","name","options","createInstance","useCallback","reference","handleUpdate","state","placement","hasDocument","scrollParentElement","hasScrollableElement","ownerDocument","body","hasPointer","flipVariations","boundary","strategy","element","altBoundary","phase","fn","filter","Boolean","onFirstUpdate","createPopper","destroyInstance","destroy","scheduleUpdate","update","useImperativeHandle","updatePosition","child","Children","only","defaultProps"],"mappings":"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","sourcesContent":["import { useIsomorphicLayoutEffect } from '@fluentui/react-bindings';\nimport { Ref, isRefObject } from '@fluentui/react-component-ref';\nimport * as PopperJs from '@popperjs/core';\nimport * as _ from 'lodash';\nimport * as React from 'react';\n\nimport { isBrowser } from '../isBrowser';\nimport { getBoundary } from './getBoundary';\nimport { getScrollParent } from './getScrollParent';\nimport { getPlacement, applyRtlToOffset } from './positioningHelper';\nimport { PopperModifiers, PopperProps } from './types';\n\n/**\n * Memoize a result using deep equality. This hook has two advantages over\n * React.useMemo: it uses deep equality to compare memo keys, and it guarantees\n * that the memo function will only be called if the keys are unequal.\n * React.useMemo cannot be relied on to do this, since it is only a performance\n * optimization (see https://reactjs.org/docs/hooks-reference.html#usememo).\n *\n * Copied from https://github.com/apollographql/react-apollo/blob/master/packages/hooks/src/utils/useDeepMemo.ts.\n */\nfunction useDeepMemo<TKey, TValue>(memoFn: () => TValue, key: TKey): TValue {\n  const ref = React.useRef<{ key: TKey; value: TValue }>();\n\n  if (!ref.current || !_.isEqual(key, ref.current.key)) {\n    ref.current = { key, value: memoFn() };\n  }\n\n  return ref.current.value;\n}\n\n/** Checks if components was mounted the first time. */\nfunction useFirstMount(): boolean {\n  const isFirst = React.useRef(true);\n\n  if (isFirst.current) {\n    isFirst.current = false;\n    return true;\n  }\n\n  return isFirst.current;\n}\n\n/** Executes useIsomorphicLayoutEffect during only updates. */\nconst useUpdateIsomorphicLayoutEffect: typeof React.useLayoutEffect = (effect, deps) => {\n  const isFirstMount = useFirstMount();\n\n  useIsomorphicLayoutEffect(() => {\n    if (!isFirstMount) {\n      return effect();\n    }\n  }, deps);\n};\n\n/**\n * Popper relies on the 3rd party library [Popper.js](https://github.com/FezVrasta/popper.js) for positioning.\n */\nexport const Popper: React.FunctionComponent<PopperProps> = props => {\n  const {\n    align,\n    children,\n    enabled,\n    flipBoundary,\n    modifiers: userModifiers,\n    offset,\n    overflowBoundary,\n    pointerTargetRef,\n    popperRef,\n    position,\n    positionFixed,\n    positioningDependencies = [],\n    rtl,\n    targetRef,\n    unstable_pinned,\n  } = props;\n\n  const proposedPlacement = getPlacement({ align, position, rtl });\n\n  const popperInstanceRef = React.useRef<PopperJs.Instance>();\n  const contentRef = React.useRef<HTMLElement>(null);\n\n  const latestPlacement = React.useRef<PopperJs.Placement>(proposedPlacement);\n  const [computedPlacement, setComputedPlacement] = React.useState<PopperJs.Placement>(proposedPlacement);\n\n  const computedModifiers = useDeepMemo<any, PopperModifiers>(\n    () => [\n      offset && {\n        name: 'offset',\n        options: { offset: rtl ? applyRtlToOffset(offset) : offset },\n      },\n      ...userModifiers,\n    ],\n    [offset, flipBoundary, overflowBoundary, userModifiers],\n  );\n\n  const createInstance = React.useCallback(() => {\n    const reference: Element | PopperJs.VirtualElement =\n      targetRef && isRefObject(targetRef)\n        ? (targetRef as React.RefObject<Element>).current\n        : (targetRef as PopperJs.VirtualElement);\n\n    if (!enabled || !reference || !contentRef.current) {\n      return;\n    }\n\n    const handleUpdate = ({ state }: { state: Partial<PopperJs.State> }) => {\n      // PopperJS performs computations that might update the computed placement: auto positioning, flipping the\n      // placement in case the popper box should be rendered at the edge of the viewport and does not fit\n      if (state.placement !== latestPlacement.current) {\n        latestPlacement.current = state.placement;\n        setComputedPlacement(state.placement);\n      }\n    };\n\n    const hasDocument = isBrowser();\n    const scrollParentElement: Node | null = hasDocument ? getScrollParent(contentRef.current) : null;\n\n    const hasScrollableElement = scrollParentElement\n      ? scrollParentElement !== scrollParentElement.ownerDocument.body\n      : false;\n    const hasPointer = !!(pointerTargetRef && pointerTargetRef.current);\n\n    const modifiers: PopperModifiers = [\n      { name: 'flip', options: { flipVariations: true } },\n\n      /**\n       * unstable_pinned disables the flip modifier by setting flip.enabled to false; this\n       * disables automatic repositioning of the popper box; it will always be placed according to\n       * the values of `align` and `position` props, regardless of the size of the component, the\n       * reference element or the viewport.\n       */\n      unstable_pinned && { name: 'flip', enabled: false },\n\n      /**\n       * When the popper box is placed in the context of a scrollable element, we need to set\n       * preventOverflow.escapeWithReference to true and flip.boundariesElement to 'scrollParent'\n       * (default is 'viewport') so that the popper box will stick with the targetRef when we\n       * scroll targetRef out of the viewport.\n       */\n      hasScrollableElement && { name: 'flip', options: { boundary: 'clippingParents' } },\n      hasScrollableElement && { name: 'preventOverflow', options: { boundary: 'clippingParents' } },\n    ];\n\n    const options: PopperJs.Options = {\n      placement: proposedPlacement,\n      strategy: positionFixed ? 'fixed' : 'absolute',\n      modifiers: [\n        ...(modifiers as PopperJs.Options['modifiers']),\n\n        ...computedModifiers,\n\n        /**\n         * This modifier is necessary in order to render the pointer. Refs are resolved in effects, so it can't be\n         * placed under computed modifiers. Deep merge is not required as this modifier has only these properties.\n         */\n        {\n          name: 'arrow',\n          enabled: hasPointer,\n          options: {\n            element: pointerTargetRef && pointerTargetRef.current,\n          },\n        },\n\n        flipBoundary && {\n          name: 'flip',\n          options: {\n            altBoundary: true,\n            boundary: getBoundary(contentRef.current, flipBoundary),\n          },\n        },\n        overflowBoundary && {\n          name: 'preventOverflow',\n          options: {\n            altBoundary: true,\n            boundary: getBoundary(contentRef.current, overflowBoundary),\n          },\n        },\n\n        {\n          name: 'onUpdate',\n          enabled: true,\n          phase: 'afterWrite' as PopperJs.ModifierPhases,\n          fn: handleUpdate,\n        },\n      ].filter(Boolean),\n      onFirstUpdate: state => handleUpdate({ state }),\n    };\n\n    popperInstanceRef.current = PopperJs.createPopper(reference, contentRef.current, options);\n  }, [\n    contentRef,\n    computedModifiers,\n    enabled,\n    flipBoundary,\n    overflowBoundary,\n    pointerTargetRef,\n    positionFixed,\n    proposedPlacement,\n    targetRef,\n    unstable_pinned,\n  ]);\n\n  const destroyInstance = React.useCallback(() => {\n    if (popperInstanceRef.current) {\n      popperInstanceRef.current.destroy();\n      popperInstanceRef.current = null;\n    }\n  }, []);\n\n  const scheduleUpdate = React.useCallback(() => {\n    if (popperInstanceRef.current) {\n      popperInstanceRef.current.update();\n    }\n  }, []);\n\n  React.useImperativeHandle(\n    popperRef,\n    () => ({\n      updatePosition: scheduleUpdate,\n    }),\n    [scheduleUpdate],\n  );\n\n  useIsomorphicLayoutEffect(() => {\n    createInstance();\n    return destroyInstance;\n  }, [createInstance]);\n\n  useUpdateIsomorphicLayoutEffect(scheduleUpdate, [...positioningDependencies, computedPlacement]);\n\n  const child =\n    typeof children === 'function'\n      ? children({ placement: computedPlacement, scheduleUpdate })\n      : (children as React.ReactElement);\n\n  return child ? <Ref innerRef={contentRef}>{React.Children.only(child)}</Ref> : null;\n};\n\nPopper.defaultProps = {\n  enabled: true,\n  modifiers: [],\n  positionFixed: false,\n  positioningDependencies: [],\n};\n"],"file":"Popper.js"}